<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Mapa de mi ubicación actual</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cargar la API de Google Maps de forma asíncrona con callback -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyyyFvScvEJiM7ycNxXFtTkASQQffKpM0&callback=initMap"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const socket = io('https://mt.spotifind.eus');

      let map;
      let markers = {}; // Almacenar los marcadores de los usuarios conectados

      function initMap() {
        // Crear el mapa con una ubicación predeterminada
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: -34.397, lng: 150.644 },
          zoom: 2
        });

        // Intentar obtener la ubicación del usuario
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // Emitir la ubicación del usuario al servidor
              socket.emit('user-location', pos);

              // Centrar el mapa en la ubicación del usuario
              map.setCenter(pos);
              map.setZoom(14);

              // Añadir marcador en la ubicación del usuario
              addMarker(pos, 'Tu ubicación');
            },
            function() {
              handleLocationError(true, map.getCenter());
            }
          );
        } else {
          // Si el navegador no soporta geolocalización
          handleLocationError(false, map.getCenter());
        }

        // Manejar la actualización de ubicaciones de otros usuarios
        socket.on('update_user_locations', function(locations) {
          locations.forEach(location => {
            if (markers[location.userId]) {
              // Actualizar la posición de un marcador existente
              markers[location.userId].setPosition(new google.maps.LatLng(location.lat, location.lng));
            } else {
              // Crear un nuevo marcador si no existe
              const marker = new google.maps.Marker({
                position: { lat: location.lat, lng: location.lng },
                map: map,
                title: `Usuario: ${location.userId}`
              });
              markers[location.userId] = marker;
            }
          });
        });
      }

      // Función para manejar errores de geolocalización
      function handleLocationError(browserHasGeolocation, pos) {
        var infoWindow = new google.maps.InfoWindow({
          position: pos,
          content: browserHasGeolocation
            ? 'Error: El servicio de geolocalización falló.'
            : 'Error: Tu navegador no soporta geolocalización.'
        });
        infoWindow.open(map);
      }

      // Función para añadir un marcador al mapa
      function addMarker(location, title) {
        new google.maps.Marker({
          position: location,
          map: map,
          title: title
        });
      }

      // Función para eliminar un marcador del mapa 
      function removeMarker(userId){
        if (markers[userId]){
          markers[userId].setMap(null); // eliminarlo del mapa
          delete markers[userId]; // eliminarlo del diccionario
        }
      }

      //socket.on('remove_user_location', function(userId){

        //removeMarker(userId);

      //});


    </script>
  </body>
</html>
