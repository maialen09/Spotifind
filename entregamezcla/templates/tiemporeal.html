<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../static/tiemporeal.css">
</head>
<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
<body>
    <h1>Current Users</h1>
    <ul id="user-list"></ul> <!-- Lista de usuarios en tiempo real -->

    <h1>Your Chats</h1>
    <ul id="chat-list"></ul> <!-- Lista de chats anteriores -->

    <div id="track-info">
        <!-- Aquí se mostrará la información de la canción o el mensaje -->
    </div>

    <div id="songModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="song-window">
                <!-- Primera lista de canciones -->
                <div class="song-list">
                    {% for song in lista1 %}
                    <div class="song-item">
                        <img src="{{ song['image_url'] }}" alt="Portada de la canción">
                        <p class="song-title">{{ song['name'] }}</p>
                        <p class="song-artist">{{ song['artist'] }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Segunda lista de canciones -->
                <div class="song-list">
                    {% for song in lista2 %}
                    <div class="song-item">
                        <img src="{{ song['image_url'] }}" alt="Portada de la canción">
                        <p class="song-title">{{ song['name'] }}</p>
                        <p class="song-artist">{{ song['artist'] }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>


    <script>
        const socket = io();
        let currentChatUserId = null;
        let activeChats = {}; // lista de ventanas de chat abiertas

        // Recibir la lista de usuarios en tiempo real del servidor
        socket.on('update_user_list', function(personas) {
            const userList = document.getElementById('user-list');
            userList.innerHTML = ''; // Limpiar la lista existente

            personas.forEach(persona => {
                const li = document.createElement('li');
                li.textContent = `ID: ${persona.id}, Canción: ${persona.track}, Artista: ${persona.artist}`;

                const img = document.createElement('img');
                img.src = persona.imagen[0];
                img.setAttribute('data-id', persona.id);
                img.setAttribute('data-username', persona.usuario);
                img.classList.add('clickable-image');
                img.addEventListener('click', function() {
                    openMenu(this.getAttribute('data-id'), this.getAttribute('data-username'));
                });

                li.appendChild(img);
                userList.appendChild(li);
            });
        });

        // Recibir la lista de chats previos del servidor
        socket.on('chat_list', function(userChats) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = ''; // Limpiar la lista existente

            for (const userId in userChats) {
                const li = document.createElement('li');
                li.textContent = `Chat con el usuario: ${userId}`;

                const openChatButton = document.createElement('button');
                openChatButton.textContent = 'Abrir chat';
                openChatButton.onclick = function() {
                    openChat(userId); // Llama a la función para abrir la ventana de chat
                };

                li.appendChild(openChatButton);
                chatList.appendChild(li);
            }
        });

        // Emitir el evento para cargar los chats previos solo después de que los usuarios en tiempo real se hayan cargado
        window.onload = function() {
            socket.emit('get_chat_list'); // Solicitar la lista de chats previos
        };

        // Función para abrir el menú con botones
        function openMenu(userId, username) {
            // Si ya existe un menú abierto, cerrarlo antes de abrir uno nuevo
            const existingMenu = document.getElementById('menu-modal');
            if (existingMenu) {
                existingMenu.remove();
            }

            // Crear el menú modal
            const menuModal = document.createElement('div');
            menuModal.id = 'menu-modal';
            menuModal.classList.add('menu-modal');

            const menuHeader = document.createElement('div');
            menuHeader.classList.add('menu-header');
            menuHeader.textContent = `Opciones para ${username || userId}`;

            const openChatButton = document.createElement('button');
            openChatButton.textContent = 'Abrir chat';
            openChatButton.onclick = function() {
                closeMenu(); // Cerrar el menú
                openChat(userId, username); // Abrir el chat
            };

            const anotherOptionButton = document.createElement('button');
            anotherOptionButton.textContent = 'Vuestra canción';
            anotherOptionButton.onclick = function() {
                closeMenu();
                socket.emit('canciones_mas_escuchadas', userId);
            };

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Cerrar';
            closeButton.onclick = closeMenu;

            menuModal.appendChild(menuHeader);
            menuModal.appendChild(openChatButton);
            menuModal.appendChild(anotherOptionButton);
            menuModal.appendChild(closeButton);

            document.body.appendChild(menuModal);
        }

        function closeMenu() {
            const menuModal = document.getElementById('menu-modal');
            if (menuModal) {
                menuModal.remove(); // Eliminar el menú del DOM
            }
        }

        function mostrarCanciones(lista1, lista2){

            const songList1 = document.querySelector('#songModal .song-list:nth-child(1)');
            const songList2 = document.querySelector('#songModal .song-list:nth-child(2)');

            songList1.innerHTML = '';
            songList2.innerHTML = '';

            lista1.forEach(song => {
            const songItem = `
            <div class="song-item">
                <img src="${song.image_url}" alt="Portada de la canción">
                <p class="song-title">${song.name}</p>
                <p class="song-artist">${song.artist}</p>
            </div>
                `;
             songList1.innerHTML += songItem;
            });

    // Cargar las canciones en la segunda lista
            lista2.forEach(song => {
                const songItem = `
                    <div class="song-item">
                        <img src="${song.image_url}" alt="Portada de la canción">
                        <p class="song-title">${song.name}</p>
                        <p class="song-artist">${song.artist}</p>
                    </div>
                `;
                songList2.innerHTML += songItem;
            });
        }

        socket.on('canciones', function(data){

            const modal = document.getElementById('songModal');

            const closeBtn = document.querySelector('.close-btn');

            modal.style.display = 'block';

            closeBtn.onclick = function() {
              modal.style.display = 'none';
            }

            mostrarCanciones(data.access_token, data.otro_access_token);

            imprimir(data.access_token);
            imprimir(data.otro_access_token);
        });

        
socket.on('track', function(track) {
    const trackContainer = document.getElementById('track-info');

    if (track.status === 'match') {
        // Si hay coincidencia, mostrar la imagen, nombre y artista
        trackContainer.innerHTML = `
            <div>
                <img src="${track.image_url}" alt="Portada del Álbum" style="width: 200px; height: 200px;">
                <h2>Canción: ${track.name}</h2>
                <h3>Artista: ${track.artist}</h3>
            </div>
        `;
    } else if (track.status === 'no_match') {
        // Si no hay coincidencia, mostrar mensaje
        trackContainer.innerHTML = `
            <div>
                <h2>${track.message}</h2>
            </div>
        `;
    }
});
     
socket.on('imprimir' , function(data){

    imprimir(data);
})

        function imprimir(data){

            console.log(data);
        }


        // Funciones para abrir y manejar los chats
        function openChat(userId, username) {
            if (!activeChats[userId]) {
                const chatModal = document.createElement('div');
                chatModal.id = `chat-modal-${userId}`;
                chatModal.classList.add('chat-modal');

                const chatHeader = document.createElement('div');
                chatHeader.classList.add('chat-header');
                chatHeader.innerHTML = `<span>Chat with ${username || userId}</span> <button onclick="closeChat('${userId}')">Close</button>`;

                const chatMessages = document.createElement('div');
                chatMessages.id = `chat-messages-${userId}`;
                chatMessages.classList.add('chat-messages');

                const chatInput = document.createElement('input');
                chatInput.type = 'text';
                chatInput.placeholder = 'Type a message...';
                chatInput.id = `chat-input-${userId}`;

                const sendButton = document.createElement('button');
                sendButton.textContent = 'Send';
                sendButton.onclick = function() {
                    sendMessage(userId);
                };

                chatModal.appendChild(chatHeader);
                chatModal.appendChild(chatMessages);
                chatModal.appendChild(chatInput);
                chatModal.appendChild(sendButton);

                document.body.appendChild(chatModal);

                activeChats[userId] = chatModal;

                // Iniciar el chat y cargar mensajes antiguos
                socket.emit('start_chat', { userId: userId, username: username });
            }
        }

        function closeChat(userId) {
            const chatModal = document.getElementById(`chat-modal-${userId}`);
            if (chatModal) {
                chatModal.remove(); // Eliminar la ventana del DOM
                delete activeChats[userId]; // Eliminar la referencia de la ventana de chat
            }
        }

        function sendMessage(userId) {
            const messageInput = document.getElementById(`chat-input-${userId}`);
            const message = messageInput.value;
            if (message.trim()) {
                const chatMessages = document.getElementById(`chat-messages-${userId}`);
                const messageElement = document.createElement('div');
                messageElement.textContent = `You: ${message}`;
                chatMessages.appendChild(messageElement);

                socket.emit('send_message', { userId: userId, message });

                messageInput.value = ''; // Limpiar el campo de texto
                chatMessages.scrollTop = chatMessages.scrollHeight; // Desplazar hacia abajo al nuevo mensaje
            }
        }

        socket.on('receive_message', function(data) {
            const userId = data.userId;
            const chatMessages = document.getElementById(`chat-messages-${userId}`);
            if (chatMessages) {
                const messageElement = document.createElement('div');
                messageElement.textContent = `${data.username}: ${data.message}`;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Desplazar hacia abajo
            }
        });
    </script>
</body>
</html>
